<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Babylon — 3rd Person Sphere</title>
  <style>
    html,body { width:100%; height:100%; margin:0; overflow:hidden; }
    #renderCanvas { width:100%; height:100%; touch-action:none; display:block; }
    #angleDisplay {
      position: absolute;
      top: 10px; right: 10px;
      color: white;
      font-family: monospace;
      background: rgba(0,0,0,0.5);
      padding: 6px 12px;
      border-radius: 6px;
      z-index: 100;
    }
  </style>

  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/cannon.js"></script>
</head>
<body>
<canvas id="renderCanvas"></canvas>
<div id="angleDisplay">Angle: 0°</div>

<script>
const canvas = document.getElementById("renderCanvas");
const engine = new BABYLON.Engine(canvas, true);

const SETTINGS = {
  groundColor: "#33FF4B",
  skyColor:    "#9DE9FF",
  respawnY:   -20,
  moveForce:   18,
  maxSpeed:    8,
  jumpForce:   6.2,
  damp:        0.95
};

function createScene() {
  const scene = new BABYLON.Scene(engine);
  scene.clearColor = BABYLON.Color3.FromHexString(SETTINGS.skyColor);
  new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0,1,0), scene);
  scene.enablePhysics(new BABYLON.Vector3(0,-9.81,0), new BABYLON.CannonJSPlugin());

  // Ground
  const ground = BABYLON.MeshBuilder.CreateGround("ground",{width:300,height:300},scene);
  const gMat = new BABYLON.StandardMaterial("gMat",scene);
  gMat.diffuseColor = BABYLON.Color3.FromHexString(SETTINGS.groundColor);
  ground.material = gMat;
  ground.physicsImpostor = new BABYLON.PhysicsImpostor(ground,BABYLON.PhysicsImpostor.BoxImpostor,{mass:0,friction:2,restitution:0},scene);

  // Player sphere
  const sphere = BABYLON.MeshBuilder.CreateSphere("player",{diameter:2},scene);
  sphere.position.set(0,3,0);
  const sMat = new BABYLON.StandardMaterial("sMat",scene);
  sMat.diffuseColor = BABYLON.Color3.Random();
  sphere.material = sMat;
  sphere.physicsImpostor = new BABYLON.PhysicsImpostor(sphere,BABYLON.PhysicsImpostor.SphereImpostor,{mass:1,friction:0.6,restitution:0.05},scene);

  // Camera
  const camera = new BABYLON.ArcRotateCamera("cam",0,BABYLON.Tools.ToRadians(55),18,sphere.position.clone(),scene);
  camera.attachControl(canvas,true);
  camera.lowerRadiusLimit=6; camera.upperRadiusLimit=40;
  camera.wheelDeltaPercentage=0.01;

  const input = {forward:false,jump:false};

  window.addEventListener("keydown",e=>{
    if(e.key.toLowerCase()==="w") input.forward=true;
    if(e.key===" ") input.jump=true;
  });
  window.addEventListener("keyup",e=>{
    if(e.key.toLowerCase()==="w") input.forward=false;
    if(e.key===" ") input.jump=false;
  });

  const rayDown = new BABYLON.Vector3(0,-1,0);
  const grounded = () => {
    const ray = new BABYLON.Ray(sphere.position, rayDown, 1.15);
    const hit = scene.pickWithRay(ray,m=>m!==sphere);
    return hit && hit.hit;
  };

  const clampHorizontalSpeed = () => {
    const v = sphere.physicsImpostor.getLinearVelocity();
    const h = new BABYLON.Vector3(v.x,0,v.z);
    if(h.length()>SETTINGS.maxSpeed){
      h.normalize().scaleInPlace(SETTINGS.maxSpeed);
      sphere.physicsImpostor.setLinearVelocity(new BABYLON.Vector3(h.x,v.y,h.z));
    }
  };

  scene.registerBeforeRender(()=>{
    // Move forward only
    if(input.forward){
      const forward = new BABYLON.Vector3(Math.sin(camera.alpha+Math.PI),0,Math.cos(camera.alpha+Math.PI));
      const impulse = forward.scale(SETTINGS.moveForce * engine.getDeltaTime()*0.03);
      sphere.physicsImpostor.applyImpulse(impulse, sphere.getAbsolutePosition());
    } else {
      // damping when no input
      const v = sphere.physicsImpostor.getLinearVelocity();
      sphere.physicsImpostor.setLinearVelocity(new BABYLON.Vector3(v.x*SETTINGS.damp,v.y,v.z*SETTINGS.damp));
    }

    // Jump
    if(input.jump && grounded()){
      const v = sphere.physicsImpostor.getLinearVelocity();
      sphere.physicsImpostor.setLinearVelocity(new BABYLON.Vector3(v.x,SETTINGS.jumpForce,v.z));
    }

    clampHorizontalSpeed();

    // Respawn if fall
    if(sphere.position.y < SETTINGS.respawnY){
      sphere.position.set(0,6,0);
      sphere.physicsImpostor.setLinearVelocity(BABYLON.Vector3.Zero());
    }

    // Camera follows the sphere
    camera.target = BABYLON.Vector3.Lerp(camera.target, sphere.position,0.28);

    let angleDeg = (camera.alpha*180/Math.PI)%360;
    if(angleDeg<0) angleDeg+=360;
    document.getElementById("angleDisplay").textContent = "Angle: "+angleDeg.toFixed(0)+"°";
  });

  return scene;
}

const scene = createScene();
engine.runRenderLoop(()=>scene.render());
window.addEventListener("resize",()=>engine.resize());
</script>
</body>
</html>
