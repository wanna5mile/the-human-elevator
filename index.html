<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Babylon Player Updated</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            overflow: hidden;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>
</head>
<body>

<canvas id="renderCanvas"></canvas>

<script src="https://cdn.babylonjs.com/babylon.js"></script>

<script>
const canvas = document.getElementById("renderCanvas");
const engine = new BABYLON.Engine(canvas, true);

const createScene = function () {
    const scene = new BABYLON.Scene(engine);

    // Set sky color
    scene.clearColor = new BABYLON.Color3.FromHexString("#9DE9FF");

    // Physics
    scene.enablePhysics(new BABYLON.Vector3(0, -9.81, 0));

    // Camera (free camera with mouse drag)
    const camera = new BABYLON.ArcRotateCamera(
        "cam",
        Math.PI / 2,
        Math.PI / 3,
        20,
        new BABYLON.Vector3(0, 1, 0),
        scene
    );
    camera.attachControl(canvas, true);

    // Light
    new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);

    // Player (Sphere) with random color
    const player = BABYLON.MeshBuilder.CreateSphere("player", { diameter: 2 });
    player.position.y = 2;

    const sphereMat = new BABYLON.StandardMaterial("sphereMat", scene);
    sphereMat.diffuseColor = new BABYLON.Color3(Math.random(), Math.random(), Math.random());
    player.material = sphereMat;

    player.physicsImpostor = new BABYLON.PhysicsImpostor(
        player,
        BABYLON.PhysicsImpostor.SphereImpostor,
        { mass: 1, friction: 0.5, restitution: 0.1 },
        scene
    );

    // Ground (light green)
    const ground = BABYLON.MeshBuilder.CreateGround("ground", { width: 60, height: 60 });
    const groundMaterial = new BABYLON.StandardMaterial("groundMat", scene);
    groundMaterial.diffuseColor = BABYLON.Color3.FromHexString("#33FF4B");
    ground.material = groundMaterial;

    ground.physicsImpostor = new BABYLON.PhysicsImpostor(
        ground,
        BABYLON.PhysicsImpostor.BoxImpostor,
        { mass: 0 }
    );

    // Spawn cubes (random color, avoid player)
    const SAFE_RADIUS = 8;

    for (let i = 0; i < 20; i++) {
        let x, z;
        do {
            x = Math.random() * 50 - 25;
            z = Math.random() * 50 - 25;
        } while (Math.sqrt(x*x + z*z) < SAFE_RADIUS);

        const box = BABYLON.MeshBuilder.CreateBox("box" + i, { size: 2 });
        box.position.set(x, 1, z);

        const boxMat = new BABYLON.StandardMaterial("boxMat" + i, scene);
        boxMat.diffuseColor = new BABYLON.Color3(Math.random(), Math.random(), Math.random());
        box.material = boxMat;

        box.physicsImpostor = new BABYLON.PhysicsImpostor(
            box,
            BABYLON.PhysicsImpostor.BoxImpostor,
            { mass: 0, friction: 1 }
        );
    }

    // Input tracking
    const input = {
        forward: false,
        backward: false,
        left: false,
        right: false,
        jump: false
    };

    window.addEventListener("keydown", e => {
        if (e.key === "w" || e.key === "ArrowUp") input.forward = true;
        if (e.key === "s" || e.key === "ArrowDown") input.backward = true;
        if (e.key === "a" || e.key === "ArrowLeft") input.left = true;
        if (e.key === "d" || e.key === "ArrowRight") input.right = true;
        if (e.key === " ") input.jump = true;
    });

    window.addEventListener("keyup", e => {
        if (e.key === "w" || e.key === "ArrowUp") input.forward = false;
        if (e.key === "s" || e.key === "ArrowDown") input.backward = false;
        if (e.key === "a" || e.key === "ArrowLeft") input.left = false;
        if (e.key === "d" || e.key === "ArrowRight") input.right = false;
        if (e.key === " ") input.jump = false;
    });

    // Movement system
    scene.onBeforeRenderObservable.add(() => {
        const speed = 0.5;
        const jumpForce = 8;
        const pos = player.getAbsolutePosition();

        if (input.forward)  player.physicsImpostor.applyImpulse(new BABYLON.Vector3(0, 0, -speed), pos);
        if (input.backward) player.physicsImpostor.applyImpulse(new BABYLON.Vector3(0, 0, speed), pos);
        if (input.left)     player.physicsImpostor.applyImpulse(new BABYLON.Vector3(-speed, 0, 0), pos);
        if (input.right)    player.physicsImpostor.applyImpulse(new BABYLON.Vector3(speed, 0, 0), pos);

        // jump when close to ground
        if (input.jump && player.position.y <= 2.1) {
            player.physicsImpostor.applyImpulse(new BABYLON.Vector3(0, jumpForce, 0), pos);
        }
    });

    return scene;
};

const scene = createScene();
engine.runRenderLoop(() => scene.render());
window.addEventListener("resize", () => engine.resize());
</script>

</body>
</html>
